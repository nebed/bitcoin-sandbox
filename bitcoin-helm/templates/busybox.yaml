apiVersion: batch/v1
kind: Job
metadata:
  name: bitcoin-snapshot-loader
  labels:
    app: bitcoin-snapshot-loader
spec:
  backoffLimit: 1
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        app: bitcoin-snapshot-loader
    spec:
      restartPolicy: Never
      securityContext:
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 0
      containers:
        - name: snapshot-loader
          image: ghcr.io/charlieegan3/lz4-mt:latest
          imagePullPolicy: IfNotPresent
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail

              echo "Clearing /bitcoin/data directory..."
              rm -rf /bitcoin/data/*

              echo "Starting parallel streaming download, decompression, and extraction..."

              # Thread 1: bitcoin-base
              (
                echo "[Thread 1] Downloading and extracting bitcoin-base.tar.lz4..."
                wget -qO- https://snapshots.publicnode.com/bitcoin-base.tar.lz4 \
                  | lz4mt -p3 -d \
                  | tar -x -C /bitcoin/data/ --checkpoint=.5000 --checkpoint-action=echo="[Thread 1] Extracted 5000 files"
                echo "[Thread 1] Done."
              ) &

              # Thread 2: bitcoin-part
              (
                echo "[Thread 2] Downloading and extracting bitcoin-part-921638.tar.lz4..."
                wget -qO- https://snapshots.publicnode.com/bitcoin-part-921638.tar.lz4 \
                  | lz4mt -p3 -d \
                  | tar -x -C /bitcoin/data/ --checkpoint=.5000 --checkpoint-action=echo="[Thread 2] Extracted 5000 files"
                echo "[Thread 2] Done."
              ) &

              # Wait for both streams to finish
              wait

              echo "Fixing permissions to UID:GID 1000:1000..."
              chown -R 1000:1000 /bitcoin/data

              echo "âœ… Fully parallel snapshot download and extraction complete!"
          resources:
            requests:
              cpu: "3"
              memory: "8Gi"
            limits:
              cpu: "3"
              memory: "8Gi"
          volumeMounts:
            - name: bitcoin-data
              mountPath: /bitcoin/data
      volumes:
        - name: bitcoin-data
          persistentVolumeClaim:
            claimName: bitcoin-data-bitcoind-0
